<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../ajax-manager/ajax-manager.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">


<!--

Example indroduction

### Usage

example Usage

    usage

### Styling
 Custom property | Description | Default
----------------|-------------|----------
`--example-color` | example color | `#f1ecef`

@demo demo/.html
-->
<dom-module id="ac-player">
    <template>
        <style>
            :host {
            }
        </style>
        <iron-localstorage name="alicia_adorada4" value="{{instrumentActivity}}" ></iron-localstorage>
        <iron-localstorage name="alicia_adorada_velocities4" value="{{velocities}}"></iron-localstorage>
    </template>
    <script>
        Polymer({
            is: "ac-player",
            observers: [],
            behaviors:[],
            listeners: {
            },
            properties: {
                lookAhead:{
                    type:Number,
                    value:10
                },
                nextNoteIndex:{
                    type:Number,
                    value:0
                },
                instrumentActivity:{
                    type:Object
                },
                velocities:{
                    type:Object
                },
                updatingTempo:{
                    type:Boolean,
                    value:false
                },
                tempo:{
                    type:Number,
                    value:100
                },
                lastVelocity:{
                    type:Number,
                    value:127
                },
                playTime:{
                    type:Number,
                    value:0
                },
                playBackTime:{
                    type:Number,
                    value:0
                },
                playing:{
                    type:Boolean,
                    value:false
                },
            },
            updateTempo: function(tempo){
                if ( !this.updatingTempo) {
                    this.updatingTempo =true ;
                    this.pause() ;
                    this.async(function(){
                        var tempoAux = 100/this.tempo ;
                        this.playBackTime/=tempoAux ;

                        tempoAux = tempo/100 ;
                        this.playBackTime/=tempoAux ;

                        this.tempo= tempo ;
                        this.play();
                        this.updatingTempo = false ;
                    } , 1000 )  ;
                }
            },
            scheduleNotes: function(){
                if (this.playing){
                    this.playBackTime = context.currentTime-this.playTime ;
                    while (this.instrumentActivity.recording[this.nextNoteIndex]!== undefined  && (this.playBackTime < this.instrumentActivity.recording[this.nextNoteIndex].time && this.instrumentActivity.recording[this.nextNoteIndex].time < this.playBackTime+this.lookAhead) ){
                        var ac = this.instrumentActivity.recording[this.nextNoteIndex] ;
                        this.nextNoteIndex ++ ;
                        if( ac.button === -1 ){
                            continue ;
                        }
                        var when = context.currentTime+(ac.time-this.playBackTime) ;
                        this.fire (ac.cmd, {midiNote:ac.button,time:when,channel:ac.channel}) ;
                    }
                }
            },
            play: function(){
                this.playing = true;
                this.fire('velocity-change', {velocity:this.lastVelocity,fromPlayer:false}) ;
                var tempo = 1/(this.tempo/100) ;
                var it , i ;
                this.playTime = context.currentTime ;
            },
            pause: function(){
                if ( this.playTime === 0)
                    this.playTime = context.currentTime ;
                this.playBackTime += context.currentTime-this.playTime ;
                this.playing =false ;
                this.fire('velocity-change', {velocity:0,fromPlayer:false}) ;
            }
        });
    </script>
</dom-module>
