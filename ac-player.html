<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../ajax-manager/ajax-manager.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">


<!--

Example indroduction

### Usage

example Usage

    usage

### Styling
 Custom property | Description | Default
----------------|-------------|----------
`--example-color` | example color | `#f1ecef`

@demo demo/.html
-->
<dom-module id="ac-player">
    <template>
        <style>
            :host {
            }
        </style>
        <iron-localstorage name="alicia_adorada2" value="{{instrumentActivity}}" ></iron-localstorage>
        <iron-localstorage name="alicia_adorada_velocities2" value="{{velocities}}"></iron-localstorage>
    </template>
    <script>
        Polymer({
            is: "ac-player",
            observers: [],
            behaviors:[],
            listeners: {
            },
            properties: {
                instrumentActivity:{
                    type:Object,
                    observer:'_initInstrumentActivity'
                },
                instrumentActivityEndNote:{
                    type:Array,
                    value:[]
                },
                velocities:{
                    type:Object
                },
                updatingTempo:{
                    type:Boolean,
                    value:false
                },
                tempo:{
                    type:Number,
                    value:100
                },
                lastVelocity:{
                    type:Number,
                    value:127
                },
                playTime:{
                    type:Number,
                    value:0
                },
                playBackTime:{
                    type:Number,
                    value:2.4
                },
                instrumentActivityUrl:{
                    type:String
                },
                velocitiesUrl:{
                    type:String
                },
                buffers:{
                    type:Array,
                    value:[]
                },
                playing:{
                    type:Boolean,
                    value:false
                },
                lastActivityTime:{
                    type:Number,
                    value:0
                },
            },
            _didRespond: function(){
            },
            _initInstrumentActivity: function(){
                var arr= this.instrumentActivity.recording ;
                var i ;
                for ( i = 0; i < arr.length; i++){
                    this.instrumentActivityEndNote[i] = -1 ;
                    if (arr[i].cmd === 'note-on')
                        for (var j = i+1; j < arr.length; j++)
                            if (arr[j].button=== arr[i].button ){
                                this.instrumentActivityEndNote[i] = j ;
                                    break;
                            }
                }
            },
            _getCurrentInstrumentIndex: function(){
                var arr = this.instrumentActivity.recording ;
                for (var i = 0; i < arr.length; i++) {
                    var tempo = 1/(this.tempo/100) ;
                    var cond = arr[i].time*tempo < this.playBackTime ;
                    if ( arr[i].cmd === "note-on")
                        cond &= arr[this.instrumentActivityEndNote[i]].time*tempo > this.playBackTime ;
                    else
                        cond = false ;
                    if (arr[i].time*tempo>this.playBackTime || cond)  {
                        return i;
                    }
                }
                return arr.length;
            },
            _getCurrentVelocityIndex: function(){
                var arr = this.velocities.velocities ;
                for (var i = 0; i < arr.length; i++) {
                    var tempo = 1/(this.tempo/100) ;
                    if (arr[i].time*tempo>this.playBackTime)
                        return i;
                }
                return arr.length;
            },
            updateTempo: function(tempo){
                if ( !this.updatingTempo) {
                    this.updatingTempo =true ;
                    this.pause() ;
                    this.async(function(){
                        var tempoAux = 100/this.tempo ;
                        this.playBackTime/=tempoAux ;

                        tempoAux = tempo/100 ;
                        this.playBackTime/=tempoAux ;

                        this.tempo= tempo ;
                        this.play();
                        this.updatingTempo = false ;
                    } , 1000 )  ;
                }
            },
            play: function(){
                this.playTime = context.currentTime ;
                var sIIndex = this._getCurrentInstrumentIndex () ;
                var sVIndex = this._getCurrentVelocityIndex () ;
                this.playing = true;
                this.fire('velocity-change', {velocity:this.lastVelocity,fromPlayer:false}) ;
                var tempo = 1/(this.tempo/100) ;
                var it , i ;
                for (i = sIIndex; i < this.instrumentActivity.recording.length; i++) {
                    it = this.instrumentActivity.recording[i] ;
                    var time = it.time*tempo ;
                    if ( time < this.playBackTime )
                        time = this.playBackTime;
                    this._programInstrumentActivity( time,it.cmd,it.button,it.channel) ;

                }
                for (i = sVIndex;i < this.velocities.velocities.length;i++) {
                    it = this.velocities.velocities[i] ;
                    this._programVelocityActivity(it.time*tempo,it.value) ;
                }
            },
            pause: function(){
                if ( this.playTime === 0)
                    this.playTime = context.currentTime ;
                this.playBackTime += context.currentTime-this.playTime ;
                this.playing =false ;
                this.fire('velocity-change', {velocity:0,fromPlayer:false}) ;
                while (this.buffers.length > 0 ) {
                    this.buffers[this.buffers.length-1].stop() ;
                    this.buffers.pop() ;
                }
            },
            _programInstrumentActivity: function(time,cmd,button,channel){
                var source = context.createBufferSource () ;
                source.buffer = context.createBuffer (1,1,44100) ;
                source.onended= function () {
                    if(this.playing) {
                        this.fire(cmd, {
                            channel:channel,
                            midiNote: button,
                            fromPlayer:false
                        });
                    }
                }.bind(this) ;
                source.connect(context.destination) ;
                source.start(context.currentTime+(time-this.playBackTime)) ;
                this.buffers.push(source) ;
            },
            _programVelocityActivity: function(time,velocity){
                var source = context.createBufferSource () ;
                source.buffer = context.createBuffer (1,1,44100) ;
                source.onended= function () {
                    if(this.playing) {
                        this.lastVelocity = velocity ;
                        this.fire("velocity-change", {
                            velocity: velocity,
                            fromPlayer:false
                        });
                    }
                }.bind(this) ;
                source.connect(context.destination) ;
                source.start(context.currentTime+(time-this.playBackTime)) ;
                this.buffers.push(source) ;
            }
        });
    </script>
</dom-module>
