<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../ajax-manager/ajax-manager.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">


<!--

Example indroduction

### Usage

example Usage

    usage

### Styling
 Custom property | Description | Default
----------------|-------------|----------
`--example-color` | example color | `#f1ecef`

@demo demo/.html
-->
<dom-module id="ac-player">
    <template>
        <style>
            :host {
            }
        </style>
        <iron-localstorage name="alicia_adorada4" value="{{instrumentActivity}}" ></iron-localstorage>
        <iron-localstorage name="alicia_adorada_velocities4" value="{{velocities}}"></iron-localstorage>
    </template>
    <script>
        Polymer({
            is: "ac-player",
            observers: [],
            behaviors:[],
            listeners: {
            },
            properties: {
                lookAhead:{
                    type:Number,
                    value:4
                },
                nextNoteIndex:{
                    type:Number,
                    value:0
                },
                instrumentActivity:{
                    type:Object,
                    observer:'_setRanges'
                },
                velocities:{
                    type:Object
                },
                updatingTempo:{
                    type:Boolean,
                    value:false
                },
                tempo:{
                    type:Number,
                    value:1
                },
                lastVelocity:{
                    type:Number,
                    value:127
                },
                playTime:{
                    type:Number,
                    value:0
                },
                playedTime:{
                    type:Number,
                    value:0
                },
                recordingDuration:{
                    type:Number,
                    value:0
                },
                playing:{
                    type:Boolean,
                    value:false
                }
            },
            setTempo: function(tempo){
                this.tempo = 100/tempo ;
            },
            setProgress: function(progress){
                // this.pause() ;
                this.playedTime = progress ;
            },
            _setRanges: function(){
                var i ;
                for (i = 0; i < this.instrumentActivity.recording.length; i++) {
                    if(this.instrumentActivity.recording[i].button===-1)
                        this.instrumentActivity.recording.splice(i,1) ;
                }
                var ac =this.instrumentActivity.recording ;
                for ( i = ac.length-1; i >= 0 ; i--)
                    if(ac[i].cmd==='note-off'){
                        this.recordingDuration=ac[i].time+2 ;
                        break;
                    }
                this.fire('set-recording-duration',{duration:this.recordingDuration}) ;
                for ( i = 0; i < ac.length; i++) {
                    if(ac[i].cmd!=='note-on')
                        continue ;
                    for (var j = i+1; j < ac.length; j++) {
                        if(ac[j].cmd!=='note-off' || ac[i].channel !== ac[j].channel)
                            continue ;
                        if(ac[i].button ===ac[j].button ) {
                            this.instrumentActivity.recording[i].endTime = ac[j].time ;
                            break ;
                        }
                    }
                }
            },
            scheduleNotes: function(){
                // requestAnimationFrame(this.scheduleNotes.bind(this)) ;
                // return ;
                if (this.playing){
                    var action = this.instrumentActivity.recording[this.nextNoteIndex] ;
                    if(action === undefined || action.cmd === 'note-off') {
                        this.nextNoteIndex ++ ;
                        return ;
                    }
                    if(action.time > this.playedTime + (context.currentTime-this.playTime)/(this.tempo)+this.lookAhead || synthBuffer+1 > synthBufferLen)
                        return ;
                    if( action.button !== -1  && action.cmd ==='note-on') {
                        console.log(this.nextNoteIndex);
                        this.fire ('action', {
                            cmd:action.cmd,
                            button:action.button,
                            channel:action.channel,
                            time:action.time,
                            endTime:action.endTime,
                            tempo:this.tempo,
                            playedTime:this.playedTime,
                            playTime:this.playTime,
                            origin:'playback'
                        }) ;
                    }
                    this.nextNoteIndex ++ ;
                    action = null ;
                }
            },
            play: function(){
                var ac = this.instrumentActivity.recording ;
                console.log(ac);
                this.playTime = context.currentTime ;
                this.nextNoteIndex = 0 ;
                // for (var i = 0; i < ac.length; i++) {
                //     if(ac[i].time < this.playedTime && this.playedTime < ac[i].endTime && ac[i].cmd === 'note-on' ) {
                //         this.fire ('action', {
                //             cmd:ac[i].cmd,
                //             button:ac[i].button,
                //             channel:ac[i].channel,
                //             playNow:1,
                //             endTime:ac[i].endTime,
                //             tempo:this.tempo,
                //             playedTime:this.playedTime,
                //             playTime:this.playTime,
                //             origin:'playback'
                //         }) ;
                //         this.nextNoteIndex = i+1  ;
                //     }
                // }
                for (; ac[this.nextNoteIndex]!== undefined  && this.playedTime > ac[this.nextNoteIndex].time; this.nextNoteIndex++) ;
                // var action ;
                // while(synthBuffer < synthBufferLen) {
                //     action = ac[this.nextNoteIndex] ;
                //     if(action === undefined)
                //         continue ;
                //     if(action.time > this.playedTime + (context.currentTime-this.playTime)/(this.tempo)+this.lookAhead)
                //         break ;
                //     if( action.button !== -1 && action.cmd ==='note-on') {
                //         this.fire ('action', {
                //             cmd:action.cmd,
                //             button:action.button,
                //             channel:action.channel,
                //             time:action.time,
                //             endTime:action.endTime,
                //             tempo:this.tempo,
                //             playedTime:this.playedTime,
                //             playTime:this.playTime,
                //             origin:'playback'
                //         }) ;
                //     }
                //     this.nextNoteIndex ++ ;
                //     action = null ;
                // }
                this.playing = true;
            },
            showCurrentGUIState: function(){
                var ac = this.instrumentActivity.recording ;
                for (var i = 0; i < ac.length; i++) {
                    if(ac[i].time < this.playedTime && this.playedTime < ac[i].endTime && ac[i].cmd === 'note-on') {
                        this.fire ('action', {
                            cmd:ac[i].cmd,
                            button:ac[i].button,
                            channel:ac[i].channel,
                            playNow:1,
                            origin:'playbackGUI'
                        }) ;
                    }
                }
            },
            pause: function(){
                if(!this.playing)
                    return ;
                this.playedTime += (context.currentTime-this.playTime)/this.tempo ;
                this.playing =false ;
            },
            ready: function () {
                setInterval(this.scheduleNotes.bind(this),16) ;
                // this.scheduleNotes () ;
            }
        });
    </script>
</dom-module>
